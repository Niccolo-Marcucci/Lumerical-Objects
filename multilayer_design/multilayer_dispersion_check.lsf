#clear;

theta = linspace(40,60,0.5e4);                    # angle vector
lambda= linspace(500,640,0.5e3)*1e-9;
f = c/lambda;
loaddata('best_design');
n=idx_layers;
d=d_layers;
idx_layers(end-2)=1;
n2=idx_layers;

#N_couples=0;
#d_big=matrix(length(d)+N_couples*2);
#n_big=d_big;
#d_big(1)=d(1);
#n_big(1)=n(1);
#for(i=1:N_couples) {
    #d_big(1+2*i)=d(3);
    #d_big(1+2*i+1)=d(2);
    #n_big(1+2*i)=n(3);
    #n_big(1+2*i-1)=n(2);
#}
#d_big(1+N_couples*2+1:end)=d(2:end);
#n_big(1+N_couples*2+1:end)=n(2:end);

#RT1 = stackrt(pinch(n),pinch(d),f,theta);

#image(RT1.theta,RT1.lambda,transpose(RT1.Rp),"theta (deg)","wavelength (um)","Rp, dispersive example");
#matlabsave('dispersion',RT1);


n_big = [1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,2.53+0.0001i,2.53+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];
d_big = [2.0453e-08,2.0453e-08,2.0453e-08,2.0453e-08,2.0453e-08,2.0453e-08,2.0453e-08,2.0453e-08,2.0453e-08,2.0453e-08,2.0453e-08,2.0453e-08,2.0453e-08,2.0453e-08,2.0453e-08,2.0453e-08,1.7672e-08,1.527e-08,1.5223e-08,1.3194e-08,1.14e-08,1.14e-08,1.14e-08,1.14e-08,1.14e-08,1.14e-08,1.14e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.14e-08,1.14e-08,1.14e-08,1.14e-08,1.14e-08,1.14e-08,1.14e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,1.2441e-08,1.5503e-08,1.8664e-08,1.9319e-08,2.4075e-08,3.0001e-08,3.0001e-08,3.0001e-08,3.0001e-08,3.0001e-08,3.0001e-08,2.001e-08];

n_big2 = [1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,1.5,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,2.53+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,2.53+0.0001i,2.53+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1.65+0.0001i,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];
d_big2 = [2.0453e-08,2.0453e-08,2.0453e-08,2.0453e-08,2.0453e-08,2.0453e-08,2.0453e-08,2.0453e-08,2.0453e-08,2.0453e-08,2.0453e-08,2.0453e-08,2.0453e-08,2.0453e-08,2.0453e-08,2.0453e-08,1.7672e-08,1.527e-08,1.5223e-08,1.3194e-08,1.14e-08,1.14e-08,1.14e-08,1.14e-08,1.14e-08,1.14e-08,1.14e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.0896e-08,1.14e-08,1.14e-08,1.14e-08,1.14e-08,1.14e-08,1.14e-08,1.14e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.1e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,1.0949e-08,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,9.9833e-09,1.2441e-08,1.5503e-08,1.8664e-08,1.9319e-08,2.4075e-08,3.0001e-08,3.0001e-08,3.0001e-08,3.0001e-08,3.0001e-08,3.0001e-08,3.0001e-08];

f = c/570e-9;
RT1 = stackrt(pinch(n_big) ,pinch(d_big) ,f,theta);
RT2 = stackrt(pinch(n_big2),pinch(d_big2),f,theta);
RT3 = stackrt(n ,d,f,theta);
RT4 = stackrt(n2,d,f,theta);
plot(RT1.theta,(RT1.Rp),(RT3.Rp),(RT2.Rp),(RT4.Rp),"theta (deg)","Rp");

idx1=findpeaks(1-RT1.Rp);
idx2=findpeaks(1-RT2.Rp);
?n_eff1 = sin(theta(idx1)*pi/180)*1.5;
?n_eff2 = sin(theta(idx2)*pi/180)*1.5;
